<!DOCTYPE html>
<html>
<head>
  <script src="main.js"></script>
  <!--<script src="updatePreview.js"></script>-->
  <link rel="stylesheet" href="style.css">

</head>
<body>
  <!-- MAIN PANEL -->
  <div id="MainPanel">
    
    <!-- Background Preview covers entire panel -->
    <div id="backgroundPreview">
      <div id="generationPreview">
        <!-- The image element is appended/updated via JS -->
      </div>
    </div>
    <!-- Insertion Options & Generation Options -->
    <div class="insertion-options" id="insertionOptions">
<!--         <sp-dropdown id="copyOrInsert" size="m" style="width: 76px; font-size: 13px; margin: 0; padding: 0;" placeholder="Paste">
        <sp-menu slot="options">
            <sp-menu-item>Paste</sp-menu-item>
            <sp-menu-item>Copy</sp-menu-item>
        </sp-menu>
        </sp-dropdown> -->
        <sp-overlay style="position: absolute; left: 10px;">
          <sp-action-button slot="trigger" id="pickWorkflow" style="width: 36px; padding-left: 8px; stroke: #ffffff; fill: none">
            <div slot="icon">
              <svg width="18px" height="18px" viewBox="0 0 24.00 24.00" xmlns="http://www.w3.org/2000/svg">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier"><defs><style>.a{stroke-linecap:round;stroke-linejoin:round;stroke-width:1.008;}</style></defs><circle class="a" cx="12" cy="6" r="3"></circle><rect class="a" height="5" rx="2" width="8" x="2" y="16"></rect><rect class="a" height="5" rx="2" width="8" x="14" y="16"></rect><path class="a" d="M6,16V14a2,2,0,0,1,2-2h8a2,2,0,0,1,2,2v2"></path><line class="a" x1="12" x2="12" y1="9" y2="12"></line></g></svg>
            </div>
          </sp-action-button>

          <sp-popover offset="8" placement="right" alignment="right" appearance="none" slot="hover" style="border-radius: 5px;">
            <sp-body id="workflowName" style="padding: 3px 8px; width: fit-content; font-size: 12px; height: 12px;">
                Pick Workflow
            </sp-body>
          </sp-popover>
        </sp-overlay>

        <sp-dropdown id="insertSettings" size="m" style="width: 120px; font-size: 13px; margin: 0; padding: 0;" placeholder="Whole Layer">
        <sp-menu slot="options">
            <sp-menu-item id="wholeLayerOption">Whole Layer</sp-menu-item>
            <sp-menu-item id="onlyChangesOption">Only Changes</sp-menu-item>
            <sp-menu-item id="maskedLayerOption">Masked Layer</sp-menu-item>
        </sp-menu>
        </sp-dropdown>
        <sp-action-button id="insertAsLayer">
        <div slot="icon" style="fill: #177fff;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18">
            <defs />
            <path d="M4.5 4H13V1.5a.5.5 0 0 0-.5-.5h-11a.5.5 0 0 0-.5.5v11a.5.5 0 0 0 .5.5H4V4.5a.5.5 0 0 1 .5-.5Z" class="fill" />
            <path d="M16.5 5h-11a.5.5 0 0 0-.5.5v11a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5v-11a.5.5 0 0 0-.5-.5Zm-2 6.75h-2.75v2.75h-1.5v-2.75H7.5v-1.5h2.75V7.5h1.5v2.75h2.75Z" class="fill" />
            </svg>
        </div>
        </sp-action-button>

        <sp-overlay style="position: absolute; right: 10px;">
          <sp-action-button slot="trigger" id="settingsButton" style="width: 36px; stroke: #ffffff; fill: none">
            <div slot="icon">
              <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="18" height="18" viewBox="0,0,256,256">
                <g fill="#ffffff" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(5.12,5.12)"><path d="M22.20508,2c-0.48953,0.00026 -0.90693,0.35484 -0.98633,0.83789l-0.97266,5.95508c-1.16958,0.34023 -2.28485,0.7993 -3.33594,1.37109l-4.91406,-3.50977c-0.39728,-0.28369 -0.94131,-0.23911 -1.28711,0.10547l-3.89062,3.88672c-0.3432,0.34344 -0.39015,0.88376 -0.11133,1.28125l3.45703,4.94531c-0.58061,1.05722 -1.04985,2.17878 -1.39844,3.35938l-5.92969,0.98633c-0.4815,0.0811 -0.83404,0.49805 -0.83398,0.98633v5.5c-0.00088,0.48518 0.3466,0.901 0.82422,0.98633l5.93359,1.05078c0.3467,1.17855 0.81296,2.30088 1.39453,3.35937l-3.5,4.89648c-0.28369,0.39728 -0.23911,0.94131 0.10547,1.28711l3.88867,3.89063c0.34265,0.34275 0.88175,0.39048 1.2793,0.11328l4.95508,-3.46875c1.05419,0.57517 2.17218,1.03762 3.3457,1.38086l0.99023,5.96289c0.08025,0.48228 0.49742,0.83584 0.98633,0.83594h5.5c0.4858,0.00071 0.90184,-0.34778 0.98633,-0.82617l1.06055,-5.98633c1.16868,-0.3485 2.28142,-0.8178 3.33008,-1.39648l4.98828,3.5c0.39749,0.27882 0.93781,0.23187 1.28125,-0.11133l3.88867,-3.89258c0.34612,-0.34687 0.38995,-0.89343 0.10352,-1.29102l-3.55664,-4.9375c0.56867,-1.04364 1.02681,-2.14972 1.36719,-3.31055l6.01758,-1.05469c0.47839,-0.08448 0.82689,-0.50053 0.82617,-0.98633v-5.5c-0.00026,-0.48953 -0.35484,-0.90693 -0.83789,-0.98633l-6.00781,-0.98242c-0.34266,-1.15945 -0.80206,-2.26356 -1.37109,-3.30664l3.50781,-4.99805c0.27882,-0.39749 0.23187,-0.93781 -0.11133,-1.28125l-3.89062,-3.88867c-0.34687,-0.34612 -0.89343,-0.38995 -1.29102,-0.10352l-4.92383,3.54102c-1.04908,-0.57636 -2.16255,-1.04318 -3.33398,-1.38867l-1.04687,-5.98437c-0.08364,-0.47917 -0.49991,-0.82867 -0.98633,-0.82812zM23.05664,4h3.80859l0.99609,5.68555c0.06772,0.38959 0.35862,0.70269 0.74219,0.79883c1.46251,0.36446 2.83609,0.94217 4.08984,1.70117c0.34265,0.20761 0.77613,0.1907 1.10156,-0.04297l4.67969,-3.36328l2.69336,2.69336l-3.33203,4.74805c-0.22737,0.3236 -0.24268,0.75079 -0.03906,1.08984c0.75149,1.25092 1.32146,2.61583 1.68555,4.07031c0.0969,0.38717 0.41473,0.67966 0.80859,0.74414l5.70703,0.93359v3.80859l-5.71875,1.00391c-0.3899,0.06902 -0.70237,0.36157 -0.79687,0.74609c-0.35988,1.45263 -0.93019,2.8175 -1.68164,4.06836c-0.20617,0.34256 -0.18851,0.775 0.04492,1.09961l3.37891,4.68945l-2.69336,2.69531l-4.74023,-3.32617c-0.32527,-0.22783 -0.75452,-0.24163 -1.09375,-0.03516c-1.24752,0.75899 -2.62251,1.33943 -4.08008,1.70898c-0.38168,0.09622 -0.67142,0.40737 -0.74023,0.79492l-1.00977,5.6875h-3.81445l-0.94141,-5.66211c-0.06549,-0.39365 -0.35874,-0.7107 -0.74609,-0.80664c-1.46338,-0.36069 -2.84314,-0.93754 -4.10547,-1.69531c-0.33857,-0.20276 -0.76473,-0.18746 -1.08789,0.03906l-4.70312,3.29492l-2.69531,-2.69922l3.32422,-4.64648c0.23221,-0.3254 0.24834,-0.75782 0.04102,-1.09961c-0.76602,-1.26575 -1.34535,-2.6454 -1.71094,-4.11523c-0.09555,-0.38244 -0.40684,-0.67307 -0.79492,-0.74219l-5.63086,-1v-3.81445l5.62695,-0.93555c0.39312,-0.06519 0.71002,-0.35754 0.80664,-0.74414c0.36873,-1.4749 0.94778,-2.85432 1.71094,-4.11719c0.20562,-0.33876 0.19183,-0.76697 -0.03516,-1.0918l-3.28516,-4.69531l2.69727,-2.69531l4.66211,3.33203c0.32413,0.23112 0.75447,0.248 1.0957,0.04297c1.25566,-0.75415 2.63862,-1.32636 4.10352,-1.68555c0.38927,-0.09584 0.68369,-0.41486 0.74805,-0.81055zM25,17c-4.40643,0 -8,3.59357 -8,8c0,4.40643 3.59357,8 8,8c4.40643,0 8,-3.59357 8,-8c0,-4.40643 -3.59357,-8 -8,-8zM25,19c3.32555,0 6,2.67445 6,6c0,3.32555 -2.67445,6 -6,6c-3.32555,0 -6,-2.67445 -6,-6c0,-3.32555 2.67445,-6 6,-6z"></path></g></g>
                </svg>
            </div>
          </sp-action-button>

          <sp-popover offset="8" placement="right" alignment="right" appearance="none" slot="hover" style="border-radius: 5px;">
            <sp-body id="settingsHover" style="padding: 3px 8px; width: fit-content; font-size: 12px; height: 12px;">
                Settings
            </sp-body>
          </sp-popover>
        </sp-overlay>
    </div>

    <!-- <div class="settingsContainer">
      <sp-overlay id="settings">

      </sp-overlay>
    </div> -->

    <div class="lowerThird" id="lowerThird">
      <sp-overlay style="position: absolute; top: 20px;">
        <sp-slider id="denoiseSlider" slot="trigger" label="Denoise" indeterminate variant="ramp" max="1.00" min="0.10" value="0.6" step="0.05" format-options="{
          style: 'unit',
          unit: 'percent',
          width: '10px',
        }"></sp-slider>

        <sp-popover offset="8" placement="right" alignment="right" appearance="none" slot="hover" style="border-radius: 5px;">
          <sp-body id="denoiseAmount" style="padding: 3px 8px; width: fit-content; font-size: 12px; height: 12px;">
              Denoise: 60%
          </sp-body>
        </sp-popover>
      </sp-overlay>
    </div>


    <!-- Prompt Overlay goes first in DOM but appears visually below due to column-reverse -->
    

    <!-- Main Panel Dialogs -->
    <sp-dialog id="aboutDialog">
      <sp-heading slot="title">About this plugin</sp-heading>
      <sp-icon slot="icon" size="m" name="ui:InfoMedium"></sp-icon>
      <sp-body slot="description">
        This plugin is made by <a href='https://github.com/SmokeyRGB'>SmokeyRGB</a>.<br />
        Made for personal use only. Please don't be an ass and steal other peoples work.<br />
        If you are happy with my work and want to support me working on stuff like this <a id="smokeyRGBgithub" href='https://ko-fi.com/smokeyrgb'>Buy me a coffee ☕</a><br /><br />
        This plugin is free and will stay free. I am thankful for all the open-source work the AI-community has done<br />
        so far and wanted to contribute my part to an open and accessible technology for everyone.<br /><br />
        Special thanks to <a href='https://github.com/NimaNzrii'>Nima Nazari</a> who developed the Photoshop Connection node this is based on.<br />
        He started the whole project by digging out the Photoshop API from Adobe's chaotic documentation.
      </sp-body>
      <sp-button-group slot="buttongroup">
        <sp-button id="hideAbout" variant="primary">Close</sp-button>
      </sp-button-group>
    </sp-dialog>
    <sp-dialog id="selectionErrorDialog">
      <sp-heading slot="title">No active selection</sp-heading>
      <sp-icon slot="icon" size="m" name="ui:AlertMedium"></sp-icon>
      <sp-body style="margin-bottom: 0px" slot="description">
        There is no active selection.<br />
        Please make a selection before queuing.<br />
        <p style="font-size: 12px;">More information on <a href="https://creativecloud.adobe.com/learn/photoshop/web/selection-tools-basics">how to make a selection</a>.</p>
      </sp-body>
      <sp-button-group style="margin: 0px" slot="buttongroup">
        <sp-button id="hideSelectionError" variant="primary">Got it</sp-button>
      </sp-button-group>
    </sp-dialog>
    <sp-dialog id="pythonHookErrorDialog">
      <sp-heading slot="title">Python websocket not running.</sp-heading>
      <sp-icon slot="icon" size="m" name="ui:AlertMedium"></sp-icon>
      <sp-body style="margin-bottom: 0px" slot="description">
        The python websocket to communicate with ComfyUI is not running.<br />
        To use features like "Cancel Queue", you'll have to start the server.<br /><br />
        Photoshop will prompt you if it is allowed to open the path where you can start the server.<br />
        Either allow and start the server, or block and don't use the features.<br /><br />
        Next, you'll need to click on the sandwich menu top right of the plugin,<br />
        and choose "Connect to ComfyUI Websocket" under Debug Options.
      </sp-body>
      <sp-button-group style="margin: 0px" slot="buttongroup">
        <sp-button id="hidePythonHookError" variant="primary">Got it</sp-button>
      </sp-button-group>
    </sp-dialog>

    <sp-dialog dismissable id="settingsDialog">
      <sp-card style="border-radius: 10px;background: #282828; border: 1px solid #5f5f5f; padding: 20px; padding-top: 5px">
        <sp-heading size="s" slot="title">Settings</sp-heading>
        <sp-divider style="margin :5px"></sp-divider>
        <sp-body slot="description">
          <div>
            <sp-card class="settingsCard">
              <p slot="description" style="font-size: 14px;">Select the folder where ComfyUI is installed.</p>
              <sp-divider style="margin :5px"></sp-divider>
              <div slot="footer">
                <sp-action-button slot="trigger" id="selectComfyUIFolderButton" style="height: 25px">
                  Select
                </sp-action-button>
                <sp-label id="comfyUIFolderPath" style="margin-left: 10px; font-size: 12px; color: #c71111;">No folder selected</sp-label>
              </div>
            </sp-card>
          </div>  
          <div>
            <sp-card class="settingsCard">
              <p slot="description" style="font-size: 14px;">Connect to the python webserver (if connection failed)</p>
              <sp-divider style="margin :5px"></sp-divider>
              <div slot="footer">
                <sp-action-button slot="trigger" id="connectPythonWebsocketButton" style="height: 25px">
                  Connect
                </sp-action-button>
                <sp-textfield placeholder="127.0.0.1:6789" size="s"></sp-textfield>
                <sp-label id="comfyUIFolderPath" style="margin-left: 10px; font-size: 12px; color: #c71111;">🔴</sp-label>
              </div>
            </sp-card>
          </div>  
        </sp-body>
        
        <sp-button-group slot="buttongroup">
          <sp-button id="hideSettings" variant="primary">Close</sp-button>
        </sp-button-group>
      </sp-card>

    </sp-dialog>
  </div>

  <footer></footer>

  <!-- MINI QUEUE PANEL -->
  <div id="miniQueuePanel" style="display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
    <!-- New prompt overlay (top) -->
    <div id="promptOverlay">

        <div class="prompt-option">
            <sp-textarea id="positivePrompt" rows="1" style="width: 100%; text-align: center; border-radius: 5px;" placeholder="Positive Prompt"></sp-textarea>
        </div>

        <div class="prompt-option" style="display: none;">
            <sp-textfield id="negativePrompt" style="width: 100%; text-align: center; border-radius: 5px;" placeholder="Negative Prompt"></sp-textfield>
        </div>
        
        <div class="prompt-option" style="display: flex; align-items: center; justify-content: space-evenly; width: 100%; gap: 0.5rem;">
            <div id="advPromptingButton" title="Toggle advanced prompt settings" style="display: flex; align-items: center; justify-content: center; height: 30px; width: 40px; border-radius: 4px;">
                <sp-icon id="advPromptingIcon" size="s" name="ui:More"></sp-icon>
            </div>
            <sp-textfield id="steps" placeholder="Steps" style="flex-grow: 1; min-width: 50px; max-width: 50px; display: none;"></sp-textfield>
            <sp-textfield id="seed" placeholder="Seed" style="flex-grow: 2; min-width: 150px; max-width: 175px;"></sp-textfield>
            <sp-textfield id="cfg" placeholder="CFG" style="flex-grow: 1; min-width: 50px; max-width: 50px; display: none;"></sp-textfield>
            <sp-action-button id="randomizeSeed" style="display: flex; align-items: center; justify-content: center;">
                <a id="randomizeSeedIcon">🎲</a>
            </sp-action-button>
        </div>
            <!-- New queue button container (moved below promptOverlay) -->
   
      <div id="queueButtonContainer" >
        <sp-button id="queueButton" variant="cta" style="z-index: 5;" slot="trigger">Queue</sp-button>
        <div id="queueButtonProgress" style="
        position: absolute;
        top: 0;
        left: 50%;
        width: 0;
        height: 97%;
        background-color: rgba(255, 255, 255, 0.5);
        transition: width 0.3s ease, left 0.3s ease;
        z-index: -1;
        pointer-events: none;
        border-radius: 16px;">
        </div>
      </div>

    </div>
  </div>

   <!-- PROMPT INFORMATION PANEL -->
  <div id="comfyuiWebView">
    <div id="comfyuiWebViewBody">
      <div id="app" style="height: 100%"></div>
    </div>
  </div>


  <!-- PROMPT INFORMATION PANEL -->
  <div id="promptInfoPanel" style="margin: 5px">
    <div style="display: inline-flex; width: 100%; overflow: hidden; white-space: nowrap"> 
      <table>
        <thead></thead>
        <tbody>
          <tr>
            <td>
              <sp-textfield size="s" style="width:70%" id="posPromptInfo">
                <sp-label slot="label" style="padding:0px">Positive Prompt</sp-label>
              </sp-textfield>
              <sp-action-button disabled id="promptInfoRecyclePositiveButton" class="promptInfoButtons" size="s">♻</sp-action-button>
              <sp-action-button disabled id="promptInfoCopyPositiveButton" class="promptInfoButtons" size="s">📋</sp-action-button>
            </td>
          </tr>
          <tr>
            <td>
              <sp-textfield size="s" style="width:70%" id="negPromptInfo">
                <sp-label slot="label" style="padding:0px">Negative Prompt</sp-label>
              </sp-textfield>
              <sp-action-button disabled id="promptInfoRecycleNegativeButton" class="promptInfoButtons" size="s">♻</sp-action-button>
              <sp-action-button disabled id="promptInfoCopyNegativeButton" class="promptInfoButtons" size="s">📋</sp-action-button>
            </td>
          </tr>
          <tr>
            <td>
              <sp-textfield size="s" style="width:70%" id="seedPromptInfo">
                <sp-label slot="label" style="padding:0px">Seed</sp-label>
              </sp-textfield>
              <sp-action-button disabled id="promptInfoRecycleSeedButton" class="promptInfoButtons" size="s">♻</sp-action-button>
              <sp-action-button disabled id="promptInfoCopySeedButton" class="promptInfoButtons" size="s">📋</sp-action-button>
            </td>
          </tr>
          <tr>
            <td>
              <sp-textfield size="s" style="width:70%" id="stepsPromptInfo">
                <sp-label slot="label" style="padding:0px">Steps</sp-label>
              </sp-textfield>
              <sp-action-button disabled id="promptInfoRecycleStepsButton" class="promptInfoButtons" size="s">♻</sp-action-button>
              <sp-action-button disabled id="promptInfoCopyStepsButton" class="promptInfoButtons" size="s">📋</sp-action-button>
            </td>
          </tr>
          <tr>
            <td>
              <sp-textfield size="s" style="width:70%" id="cfgPromptInfo">
                <sp-label slot="label" style="padding:0px">CFG</sp-label>
              </sp-textfield>
              <sp-action-button disabled id="promptInfoRecycleCfgButton" class="promptInfoButtons" size="s">♻</sp-action-button>
              <sp-action-button disabled id="promptInfoCopyCfgButton" class="promptInfoButtons" size="s">📋</sp-action-button>
            </td>
          </tr>
          <tr style="text-align: center; padding: 10px">
            <td>
              <sp-action-button id="getEmbeddedPromptInfoButton" size="s">Get Prompt</sp-action-button>
              <sp-action-button disabled id="useAllExtractedPromptInfo" class="promptInfoButtons" size="s">Use All</sp-action-button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  
</body>
</html>
